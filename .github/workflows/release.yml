name: Release Application

on:
  push:
    paths:
      - 'VERSION'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.read_version.outputs.version }}
      tag_name: ${{ steps.read_version.outputs.tag_name }}
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üìñ Read VERSION file
        id: read_version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üîÑ Sync version to all files
        run: node scripts/update-version.cjs

      - name: üíæ Commit synchronized files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json src-tauri/Cargo.toml src-tauri/tauri.conf.json README.md
          git diff --staged --quiet || git commit -m "chore: sync version ${{ steps.read_version.outputs.version }} to all files"
          git push

      - name: üè∑Ô∏è Create Git tag
        run: |
          git tag ${{ steps.read_version.outputs.tag_name }} || echo "Tag already exists"
          git push origin ${{ steps.read_version.outputs.tag_name }} || echo "Tag already pushed"

  build-and-release:
    name: Build ${{ matrix.name }}
    needs: prepare
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows x64
            bundles: "msi,nsis"
            installer_suffix: "setup.msi"
            portable_suffix: "portable.exe"

          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux x64
            bundles: "deb"
            deb_suffix: ".deb"

          - platform: macos-latest
            target: x86_64-apple-darwin
            name: macOS Intel
            bundles: "dmg"
            dmg_suffix: "intel.dmg"

          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macOS Apple Silicon
            bundles: "dmg"
            dmg_suffix: "apple-silicon.dmg"

    runs-on: ${{ matrix.platform }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: üîß Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev librsvg2-dev

      - name: üìÅ Create binaries directory
        run: mkdir -p src-tauri/binaries

      - name: üì• Download and setup FFmpeg (Windows)
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          curl -L -o ffmpeg-temp.zip https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip
          unzip -q ffmpeg-temp.zip
          mv ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe src-tauri/binaries/ffmpeg-x86_64-pc-windows-msvc.exe
          mv ffmpeg-master-latest-win64-gpl/bin/ffprobe.exe src-tauri/binaries/ffprobe-x86_64-pc-windows-msvc.exe
          
          # Standalone package
          mkdir -p ffmpeg-standalone
          cp src-tauri/binaries/ffmpeg-x86_64-pc-windows-msvc.exe ffmpeg-standalone/ffmpeg.exe
          cp src-tauri/binaries/ffprobe-x86_64-pc-windows-msvc.exe ffmpeg-standalone/ffprobe.exe
          cp ffmpeg-master-latest-win64-gpl/LICENSE.txt ffmpeg-standalone/LICENSE-FFmpeg.txt
          cd ffmpeg-standalone && 7z a -tzip ../ffmpeg-windows-x64.zip * && cd ..
          
          # Cleanup
          rm -rf ffmpeg-master-latest-win64-gpl ffmpeg-temp.zip

      - name: üì• Download and setup FFmpeg (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          curl -L -o ffmpeg-temp.tar.xz https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
          tar -xf ffmpeg-temp.tar.xz
          FFMPEG_DIR=$(find . -maxdepth 1 -type d -name "ffmpeg-*-amd64-static" | head -n 1)
          
          mv "$FFMPEG_DIR/ffmpeg" src-tauri/binaries/ffmpeg-x86_64-unknown-linux-gnu
          mv "$FFMPEG_DIR/ffprobe" src-tauri/binaries/ffprobe-x86_64-unknown-linux-gnu
          chmod +x src-tauri/binaries/ffmpeg-x86_64-unknown-linux-gnu
          chmod +x src-tauri/binaries/ffprobe-x86_64-unknown-linux-gnu
          
          # Standalone package
          mkdir -p ffmpeg-standalone
          cp src-tauri/binaries/ffmpeg-x86_64-unknown-linux-gnu ffmpeg-standalone/ffmpeg
          cp src-tauri/binaries/ffprobe-x86_64-unknown-linux-gnu ffmpeg-standalone/ffprobe
          cp "$FFMPEG_DIR/GPLv3.txt" ffmpeg-standalone/LICENSE-FFmpeg.txt
          tar -czf ffmpeg-linux-x64.tar.gz -C ffmpeg-standalone .
          
          # Cleanup
          rm -rf "$FFMPEG_DIR" ffmpeg-temp.tar.xz

      - name: üì• Download and setup FFmpeg (macOS Intel)
        if: matrix.platform == 'macos-latest' && matrix.target == 'x86_64-apple-darwin'
        run: |
          curl -L -o ffmpeg-temp.zip https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip
          curl -L -o ffprobe-temp.zip https://evermeet.cx/ffmpeg/getrelease/ffprobe/zip
          unzip -q ffmpeg-temp.zip
          unzip -q ffprobe-temp.zip
          
          mv ffmpeg src-tauri/binaries/ffmpeg-x86_64-apple-darwin
          mv ffprobe src-tauri/binaries/ffprobe-x86_64-apple-darwin
          chmod +x src-tauri/binaries/ffmpeg-x86_64-apple-darwin
          chmod +x src-tauri/binaries/ffprobe-x86_64-apple-darwin
          
          # Standalone package
          mkdir -p ffmpeg-standalone
          cp src-tauri/binaries/ffmpeg-x86_64-apple-darwin ffmpeg-standalone/ffmpeg
          cp src-tauri/binaries/ffprobe-x86_64-apple-darwin ffmpeg-standalone/ffprobe
          echo "FFmpeg GPL v2 / LGPL v2.1 - https://evermeet.cx/ffmpeg/" > ffmpeg-standalone/LICENSE-FFmpeg.txt
          cd ffmpeg-standalone && zip -r -q ../ffmpeg-macos-intel.zip . && cd ..
          
          # Cleanup
          rm -f ffmpeg-temp.zip ffprobe-temp.zip

      - name: üì• Download and setup FFmpeg (macOS ARM)
        if: matrix.platform == 'macos-latest' && matrix.target == 'aarch64-apple-darwin'
        run: |
          curl -L -o ffmpeg-temp.zip "https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip?arch=arm64"
          curl -L -o ffprobe-temp.zip "https://evermeet.cx/ffmpeg/getrelease/ffprobe/zip?arch=arm64"
          unzip -q ffmpeg-temp.zip
          unzip -q ffprobe-temp.zip
          
          mv ffmpeg src-tauri/binaries/ffmpeg-aarch64-apple-darwin
          mv ffprobe src-tauri/binaries/ffprobe-aarch64-apple-darwin
          chmod +x src-tauri/binaries/ffmpeg-aarch64-apple-darwin
          chmod +x src-tauri/binaries/ffprobe-aarch64-apple-darwin
          
          # Standalone package
          mkdir -p ffmpeg-standalone
          cp src-tauri/binaries/ffmpeg-aarch64-apple-darwin ffmpeg-standalone/ffmpeg
          cp src-tauri/binaries/ffprobe-aarch64-apple-darwin ffmpeg-standalone/ffprobe
          echo "FFmpeg GPL v2 / LGPL v2.1 - https://evermeet.cx/ffmpeg/" > ffmpeg-standalone/LICENSE-FFmpeg.txt
          cd ffmpeg-standalone && zip -r -q ../ffmpeg-macos-arm64.zip . && cd ..
          
          # Cleanup
          rm -f ffmpeg-temp.zip ffprobe-temp.zip

      - name: üì¶ Install npm dependencies
        run: npm ci

      - name: üèóÔ∏è Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ needs.prepare.outputs.tag_name }}
          releaseName: "MuXolotl Converter v${{ needs.prepare.outputs.version }}"
          releaseBody: |
            <div align="center">
            
            # ü¶é MuXolotl Converter v${{ needs.prepare.outputs.version }}
            
            ### *Professional Audio & Video Conversion Made Simple*
            
            ![Platform](https://img.shields.io/badge/platform-Windows%20%7C%20macOS%20%7C%20Linux-blue?style=flat-square)
            ![License](https://img.shields.io/badge/license-GPL%20v2%20%2F%20LGPL%20v2.1-green?style=flat-square)
            ![Version](https://img.shields.io/badge/version-${{ needs.prepare.outputs.version }}-orange?style=flat-square)
            
            ---
            
            ## ‚ú® What Makes MuXolotl Special?
            
            <table>
            <tr>
            <td width="50%">
            
            ### üöÄ **Lightning Fast**
            - ‚ö° Hardware GPU acceleration
            - üîÑ Convert 4 files simultaneously  
            - üìä Real-time progress tracking
            - ‚è±Ô∏è Optimized encoding pipelines
            
            </td>
            <td width="50%">
            
            ### üéØ **Universal Support**
            - üéµ **Audio**: MP3, FLAC, AAC, Opus, WAV, OGG, M4A...
            - üé¨ **Video**: MP4, MKV, WebM, AVI, MOV, FLV...
            - üì¶ **40+ formats** total
            - üîß Custom codec selection
            
            </td>
            </tr>
            <tr>
            <td>
            
            ### üé® **Beautiful Interface**
            - ü™ü Modern glass-morphism design
            - üñ±Ô∏è Intuitive drag & drop
            - üíæ Persistent queue (resume anytime)
            - üåô Clean, distraction-free UI
            
            </td>
            <td>
            
            ### üîß **Professional Tools**
            - üéõÔ∏è Bitrate & quality control
            - üìê Resolution & FPS adjustment
            - üîä Audio channels & sample rate
            - ‚öôÔ∏è Advanced FFmpeg options
            
            </td>
            </tr>
            </table>
            
            </div>
            
            ---
            
            <div align="center">
            
            ## üì¶ Download & Installation
            
            ### ü™ü **Windows**
            
            | File | Description | Best For |
            |------|-------------|----------|
            | [`MuXolotl-Converter-${{ needs.prepare.outputs.version }}-windows-x64-setup.msi`](#) | **MSI Installer** | ‚úÖ **Recommended** - Full installation with shortcuts |
            | [`MuXolotl-Converter-${{ needs.prepare.outputs.version }}-windows-x64-portable.exe`](#) | **Portable EXE** | üíº Run without installation |
            
            </div>
            
            <details>
            <summary>üìù Installation Steps</summary>
            
            1. Download the MSI installer
            2. Double-click to run
            3. Follow the setup wizard
            4. Launch from Start Menu
            
            </details>
            
            ---
            
            <div align="center">
            
            ### üçé **macOS**
            
            | File | Architecture | Compatibility |
            |------|--------------|---------------|
            | [`MuXolotl-Converter-${{ needs.prepare.outputs.version }}-macos-intel.dmg`](#) | **Intel (x64)** | Mac with Intel processors |
            | [`MuXolotl-Converter-${{ needs.prepare.outputs.version }}-macos-apple-silicon.dmg`](#) | **Apple Silicon (ARM64)** | M1 / M2 / M3 / M4 Macs |
            
            </div>
            
            <details>
            <summary>üìù Installation Steps</summary>
            
            1. Download the appropriate DMG for your Mac
            2. Open the DMG file
            3. Drag **MuXolotl Converter** to Applications folder
            4. **First launch**: Right-click ‚Üí "Open" ‚Üí Confirm (bypass Gatekeeper)
            
            </details>
            
            > ‚ö†Ô∏è **Security Note**: macOS may block unsigned apps. Use Right-click ‚Üí Open on first launch.
            
            ---
            
            <div align="center">
            
            ### üêß **Linux**
            
            | File | Format | Distribution |
            |------|--------|--------------|
            | _`Not yet available`_ | **AppImage** | ‚úÖ **Universal** (any distro) |
            | [`MuXolotl-Converter-${{ needs.prepare.outputs.version }}-linux-x64.deb`](#) | **DEB Package** | Debian, Ubuntu, Mint, Pop!_OS |
            
            </div>
            
            <details>
            <summary>üìù AppImage Installation</summary>
            
            ```bash
            # Download the AppImage
            chmod +x MuXolotl-Converter-${{ needs.prepare.outputs.version }}-linux-x64.AppImage
            ./MuXolotl-Converter-${{ needs.prepare.outputs.version }}-linux-x64.AppImage
            ```
            
            </details>
            
            <details>
            <summary>üìù DEB Installation</summary>
            
            ```bash
            sudo dpkg -i MuXolotl-Converter-${{ needs.prepare.outputs.version }}-linux-x64.deb
            # If dependencies are missing:
            sudo apt-get install -f
            ```
            
            </details>
            
            ---
            
            <div align="center">
            
            ## üõ†Ô∏è Standalone FFmpeg Binaries
            
            Pre-compiled FFmpeg static builds included for all platforms:
            
            | Platform | File | Features |
            |----------|------|----------|
            | **Windows x64** | `ffmpeg-windows-x64.zip` | Full GPL build, all codecs, static linking |
            | **Linux x64** | `ffmpeg-linux-x64.tar.gz` | Static build, zero dependencies |
            | **macOS Intel** | `ffmpeg-macos-intel.zip` | Optimized for x86_64 architecture |
            | **macOS ARM64** | `ffmpeg-macos-arm64.zip` | Native Apple Silicon binaries |
            
            **What's inside**: `ffmpeg`, `ffprobe`, license files  
            **License**: GPL v2 / LGPL v2.1  
            **Sources**: [FFmpeg-Builds](https://github.com/BtbN/FFmpeg-Builds) ‚Ä¢ [evermeet.cx](https://evermeet.cx/ffmpeg/)
            
            ---
            
            ## ‚öôÔ∏è System Requirements
            
            <table>
            <tr>
            <td width="50%">
            
            **Minimum**
            - Windows 10 / macOS 10.15 / Linux (64-bit)
            - 4 GB RAM
            - 200 MB disk space
            - Any CPU (2+ cores recommended)
            
            </td>
            <td width="50%">
            
            **Recommended for Best Performance**
            - Windows 11 / macOS 12+ / Ubuntu 22.04+
            - 8 GB+ RAM
            - SSD storage
            - GPU: NVIDIA GTX 600+ / Intel HD 4000+ / AMD 7000+ / Apple M1+
            
            </td>
            </tr>
            </table>
            
            </div>
            
            ---
            
            ## üöÄ Quick Start
            
            ```
            1Ô∏è‚É£  Launch MuXolotl Converter
            2Ô∏è‚É£  Drag & drop your media files (or click to browse)
            3Ô∏è‚É£  Select output format from the dropdown
            4Ô∏è‚É£  Adjust quality settings (optional)
            5Ô∏è‚É£  Click "Start Conversion"
            6Ô∏è‚É£  Find converted files in your output folder! üéâ
            ```
            
            **Pro Tips**:
            - üí° Use GPU acceleration for video (auto-detected)
            - üí° Queue up to 50 files for batch processing
            - üí° Your queue is saved - resume anytime!
            
            ---
            
            ## üéØ Key Features Breakdown
            
            ### Hardware Acceleration
            - **NVIDIA NVENC** - GTX/RTX series GPUs
            - **Intel QSV** - Quick Sync Video (HD Graphics 4000+)
            - **AMD AMF** - Radeon 7000 series and newer
            - **Apple VideoToolbox** - Native on M1/M2/M3 chips
            
            ### Supported Formats
            
            <details>
            <summary>üéµ <b>Audio Formats (25+)</b></summary>
            
            **Lossless**: FLAC, WAV, ALAC, APE, WV  
            **Lossy**: MP3, AAC, Opus, Vorbis (OGG), M4A, WMA  
            **Special**: DSD, AIFF, AMR, AC3, DTS
            
            </details>
            
            <details>
            <summary>üé¨ <b>Video Formats (20+)</b></summary>
            
            **Modern**: MP4 (H.264/H.265), MKV, WebM (VP9/AV1)  
            **Legacy**: AVI, MOV, FLV, WMV, MPG, VOB  
            **Professional**: ProRes, DNxHD, MPEG-2
            
            </details>
            
            ---
            
            ## üêõ Known Limitations
            
            - ‚ö†Ô∏è Maximum 50 files per queue
            - ‚ö†Ô∏è 1-hour timeout per file conversion
            - ‚ö†Ô∏è Some rare formats (SHN, RA, RM) may fail
            - ‚ö†Ô∏è DRM-protected files are not supported
            
            ---
            
            ## üåü Support the Project
            
            If you find MuXolotl useful:
            
            - ‚≠ê **Star this repository** (it really helps!)
            - üêõ **Report bugs** to make it better
            - üì¢ **Share** with friends and colleagues
            - üíª **Contribute** code or translations
            - üíù **Sponsor** development (if you're feeling generous!)
            
            ---
            
            <div align="center">
            
            ## üí° Need Help?
            
            <table>
            <tr>
            <td align="center" width="25%">
            
            ### üìñ
            **[Documentation](https://github.com/${{ github.repository }}#readme)**  
            Complete guide & FAQ
            
            </td>
            <td align="center" width="25%">
            
            ### üêõ
            **[Report Bug](https://github.com/${{ github.repository }}/issues/new?template=bug_report.yml)**  
            Found an issue?
            
            </td>
            <td align="center" width="25%">
            
            ### üí°
            **[Request Feature](https://github.com/${{ github.repository }}/issues/new?template=feature_request.yml)**  
            Share your ideas

            </td>
            <td align="center" width="25%">

            ### ‚ùì
            **[Question / Support](https://github.com/${{ github.repository }}/issues/new?template=question.yml)**  
            Got questions?

            </td>
            <td align="center" width="25%">

            ### üí¨
            **[Discussions](https://github.com/${{ github.repository }}/discussions)**  
            Community chat

            </td>
            </tr>
            </table>
            
            ---
            
            ### Built with ‚ù§Ô∏è using
            
            [Tauri](https://tauri.app) ‚Ä¢ [React](https://react.dev) ‚Ä¢ [FFmpeg](https://ffmpeg.org) ‚Ä¢ [Rust](https://rust-lang.org)
            
            ---
            
            **License**: [GPL v2](https://github.com/${{ github.repository }}/blob/main/LICENSE.GPL) / [LGPL v2.1](https://github.com/${{ github.repository }}/blob/main/LICENSE.LGPL)
            
            **Copyright ¬© 2025** ‚Ä¢ Made with ü¶é by the MuXolotl team
            
            </div>
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.target }} --bundles ${{ matrix.bundles }}

      - name: üè∑Ô∏è Rename artifacts
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TARGET="${{ matrix.target }}"
          BUNDLE_DIR="src-tauri/target/$TARGET/release/bundle"
          
          # Windows
          if [ "${{ matrix.platform }}" == "windows-latest" ]; then
            if [ -d "$BUNDLE_DIR/msi" ]; then
              for file in "$BUNDLE_DIR/msi"/*.msi; do
                [ -f "$file" ] && mv "$file" "$BUNDLE_DIR/msi/MuXolotl-Converter-${VERSION}-windows-x64-setup.msi"
              done
            fi
            if [ -d "$BUNDLE_DIR/nsis" ]; then
              for file in "$BUNDLE_DIR/nsis"/*.exe; do
                [ -f "$file" ] && mv "$file" "$BUNDLE_DIR/nsis/MuXolotl-Converter-${VERSION}-windows-x64-portable.exe"
              done
            fi
          fi
          
          # Linux
          if [ "${{ matrix.platform }}" == "ubuntu-22.04" ]; then
            if [ -d "$BUNDLE_DIR/deb" ]; then
              for file in "$BUNDLE_DIR/deb"/*.deb; do
                [ -f "$file" ] && mv "$file" "$BUNDLE_DIR/deb/MuXolotl-Converter-${VERSION}-linux-x64.deb"
              done
            fi
          fi
          
          # macOS Intel
          if [ "${{ matrix.platform }}" == "macos-latest" ] && [ "$TARGET" == "x86_64-apple-darwin" ]; then
            if [ -d "$BUNDLE_DIR/dmg" ]; then
              for file in "$BUNDLE_DIR/dmg"/*.dmg; do
                [ -f "$file" ] && mv "$file" "$BUNDLE_DIR/dmg/MuXolotl-Converter-${VERSION}-macos-intel.dmg"
              done
            fi
          fi
          
          # macOS ARM
          if [ "${{ matrix.platform }}" == "macos-latest" ] && [ "$TARGET" == "aarch64-apple-darwin" ]; then
            if [ -d "$BUNDLE_DIR/dmg" ]; then
              for file in "$BUNDLE_DIR/dmg"/*.dmg; do
                [ -f "$file" ] && mv "$file" "$BUNDLE_DIR/dmg/MuXolotl-Converter-${VERSION}-macos-apple-silicon.dmg"
              done
            fi
          fi

      - name: üì§ Upload release artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          files: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.{msi,exe,deb,dmg}
            ffmpeg-*.zip
            ffmpeg-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
